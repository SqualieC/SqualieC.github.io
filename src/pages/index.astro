---
import { getCollection, getEntry } from 'astro:content';
import Layout from '../layouts/Layout.astro';

const projects = (await getCollection('projects')).sort(
  (a, b) => b.data.updatedAt.valueOf() - a.data.updatedAt.valueOf()
);
const featured = projects.filter((project) => project.data.featured).slice(0, 4);
const latestProject = projects[0];

const recentPosts = (await getCollection('blog')).sort(
  (a, b) => b.data.updatedAt.valueOf() - a.data.updatedAt.valueOf()
).slice(0, 2);

const siteSettings = await getEntry('site', 'global');
const { heroHeading, heroSubtext, siteTagline } = siteSettings!.data;
---

<Layout
  title={siteTagline}
  description={heroSubtext}
>
  <section class="hero hero-surface">
    <p class="eyebrow">Portfolio</p>
    <p class="hero-intro">Hi, I'm <strong>Squalie</strong>. I'm a math major with a background in physics &amp; CS, and I play bass.</p>
    <h1>{heroHeading}</h1>
    <p class="lead">{heroSubtext}</p>
    <div class="btn-row">
      <a href="/projects" class="btn btn-secondary">Browse Projects</a>
      <a href="/projects/bassprogram" class="btn btn-primary">Download BassProgram v0.1</a>
    </div>
    {latestProject && (
      <div class="meta-row">
        <a class="badge badge-link" href={`/projects/${latestProject.slug}`}>
          Latest: {latestProject.data.title} Â· {latestProject.data.updatedAt.toISOString().slice(0, 10)}
        </a>
      </div>
    )}
  </section>

  <section>
    <h2 class="section-title">Featured Work</h2>
    <div class="grid">
      {featured.map((project) => (
        <article class="card">
          <h3>{project.data.title}</h3>
          <p>{project.data.pitch}</p>
          <div class="meta-row">
            <span class="badge">{project.data.status}</span>
            <span class="badge">{project.data.priceModel}</span>
          </div>
          <div class="btn-row">
            {project.data.downloadUrl ? (
              <a class="btn btn-primary" href={project.data.downloadUrl}>{project.data.downloadLabel ?? 'Download'}</a>
            ) : (
              <a class="btn btn-online" href={`/projects/${project.slug}`}>Open Project</a>
            )}
            <a class="btn btn-secondary" href={`/projects/${project.slug}`}>Details</a>
          </div>
        </article>
      ))}
    </div>
  </section>

  {recentPosts.length > 0 && (
    <section>
      <h2 class="section-title">Recent Posts</h2>
      <div class="grid">
        {recentPosts.map((post) => (
          <article class="card">
            <h3>{post.data.title}</h3>
            <p>{post.data.summary}</p>
            <a class="cta" href={`/blog/${post.slug}`}>Read post</a>
          </article>
        ))}
      </div>
    </section>
  )}
</Layout>
