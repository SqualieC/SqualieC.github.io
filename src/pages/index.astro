---
import { getCollection, getEntry } from 'astro:content';
import Layout from '../layouts/Layout.astro';

const projects = (await getCollection('projects')).sort(
  (a, b) => b.data.updatedAt.valueOf() - a.data.updatedAt.valueOf()
);
const featured = projects.filter((project) => project.data.featured).slice(0, 4);
const latestProject = projects[0];

const siteSettings = await getEntry('site', 'global');
const { heroHeading, heroSubtext, siteTagline } = siteSettings!.data;
---

<Layout
  title={siteTagline}
  description={heroSubtext}
>
  <section class="hero hero-surface">
    <p class="eyebrow">Portfolio</p>
    <h1>{heroHeading}</h1>
    <p class="lead">{heroSubtext}</p>
    <div class="btn-row">
      <a href="/projects" class="btn btn-secondary">Browse Projects</a>
      <a href="/projects/bassprogram" class="btn btn-primary">Download BassProgram v0.1</a>
    </div>
    {latestProject && (
      <p class="lead">Latest update: <strong>{latestProject.data.title}</strong> ({latestProject.data.updatedAt.toISOString().slice(0, 10)})</p>
    )}
  </section>

  <section>
    <h2 class="section-title">Featured Work</h2>
    <div class="grid">
      {featured.map((project) => (
        <article class="card">
          <h3>{project.data.title}</h3>
          <p>{project.data.pitch}</p>
          <div class="meta-row">
            <span class="badge">{project.data.status}</span>
            <span class="badge">{project.data.priceModel}</span>
          </div>
          <div class="btn-row">
            {project.data.downloadUrl ? (
              <a class="btn btn-primary" href={project.data.downloadUrl}>{project.data.downloadLabel ?? 'Download'}</a>
            ) : (
              <a class="btn btn-online" href={`/projects/${project.slug}`}>Open Project</a>
            )}
            <a class="btn btn-secondary" href={`/projects/${project.slug}`}>Details</a>
          </div>
        </article>
      ))}
    </div>
  </section>
</Layout>
