---
import Layout from '../../layouts/Layout.astro';
import sentences from '../../data/korean-sentences.json';
import words from '../../data/korean-words.json';
---

<Layout
  title="Korean Reading Practice | SqualieC"
  description="Read Korean first, reveal translation, and play Microsoft Edge SunHiNeural Korean audio on the live site."
>
  <section class="hero hero-surface">
    <p class="eyebrow">Online Tool</p>
    <h1>Korean Reading Practice</h1>
    <p class="lead">
      This is now fully site-hosted and always available. It uses your real sentence and vocabulary sets directly in
      the browser, with pre-rendered Microsoft Edge neural Korean TTS (SunHi) for playback quality.
    </p>
  </section>

  <section class="card section-title practice-shell">
    <div class="control-row">
      <label for="modeSelect">Mode</label>
      <select id="modeSelect" aria-label="Practice mode">
        <option value="sentences">Everyday Sentences</option>
        <option value="words">Beginner Words</option>
      </select>

      <label for="voiceSelect">Fallback Voice</label>
      <select id="voiceSelect" aria-label="Fallback voice selection"></select>

      <label for="rateRange">Rate</label>
      <input id="rateRange" type="range" min="0.7" max="1.2" step="0.05" value="0.95" />
    </div>

    <section id="koreanText" class="sentence" aria-live="polite">Loading...</section>
    <section id="englishText" class="translation hidden" aria-live="polite"></section>

    <div class="btn-row">
      <button id="newBtn" class="btn btn-primary" type="button">New Item</button>
      <button id="revealPlayBtn" class="btn btn-secondary" type="button">Reveal + Play</button>
      <button id="playBtn" class="btn btn-secondary" type="button">Play Again</button>
    </div>

    <div id="status" class="status"></div>

    <p class="hint">
      Playback uses pre-rendered <code>ko-KR-SunHiNeural</code> audio first. Browser voices are used only as fallback.
    </p>
  </section>
</Layout>

<script define:vars={{ sentences, words }}>
  const koreanTextEl = document.getElementById("koreanText");
  const englishTextEl = document.getElementById("englishText");
  const statusEl = document.getElementById("status");
  const modeSelect = document.getElementById("modeSelect");
  const voiceSelect = document.getElementById("voiceSelect");
  const rateRange = document.getElementById("rateRange");
  const newBtn = document.getElementById("newBtn");
  const revealPlayBtn = document.getElementById("revealPlayBtn");
  const playBtn = document.getElementById("playBtn");

  const pools = {
    sentences,
    words
  };

  const PREFETCHED_AUDIO_BASE = "/audio/korean";

  let current = null;
  let activeAudio = null;

  function setStatus(message) {
    statusEl.textContent = message || "";
  }

  function randomItem(mode) {
    const selectedMode = mode === "words" ? "words" : "sentences";
    const pool = pools[selectedMode] || pools.sentences;
    const index = Math.floor(Math.random() * pool.length);
    return {
      ...pool[index],
      _index: index,
      _mode: selectedMode
    };
  }

  function renderCurrent(item) {
    current = item;
    koreanTextEl.textContent = item.korean;
    englishTextEl.textContent = item.english;
    englishTextEl.classList.add("hidden");
    setStatus("");
  }

  function stopPlayback() {
    if (activeAudio) {
      activeAudio.pause();
      activeAudio.currentTime = 0;
      activeAudio = null;
    }

    if ("speechSynthesis" in window) {
      window.speechSynthesis.cancel();
    }
  }

  function loadNewItem() {
    stopPlayback();
    renderCurrent(randomItem(modeSelect.value));
  }

  function revealTranslation() {
    if (!current) return;
    englishTextEl.classList.remove("hidden");
  }

  function getKoreanVoices() {
    if (!("speechSynthesis" in window)) {
      return [];
    }

    const voices = window.speechSynthesis
      .getVoices()
      .filter((voice) => voice.lang && voice.lang.toLowerCase().startsWith("ko"));

    return voices.sort((a, b) => {
      const rank = (voice) => {
        const name = `${voice.name} ${voice.voiceURI}`.toLowerCase();
        if (name.includes("sunhi")) return 0;
        if (name.includes("online") && name.includes("korean")) return 1;
        if (name.includes("neural") && name.includes("korean")) return 2;
        if (name.includes("korean")) return 3;
        return 10;
      };

      const diff = rank(a) - rank(b);
      if (diff !== 0) return diff;
      return a.name.localeCompare(b.name);
    });
  }

  function populateVoiceSelect() {
    const voices = getKoreanVoices();
    const previousValue = voiceSelect.value;

    voiceSelect.innerHTML = "";

    if (!voices.length) {
      const option = document.createElement("option");
      option.value = "";
      option.textContent = "No Korean fallback voice found";
      voiceSelect.appendChild(option);
      return;
    }

    voices.forEach((voice, index) => {
      const option = document.createElement("option");
      option.value = voice.voiceURI;
      option.textContent = `${voice.name} (${voice.lang})`;
      if (previousValue && previousValue === voice.voiceURI) {
        option.selected = true;
      } else if (!previousValue && index === 0) {
        option.selected = true;
      }
      voiceSelect.appendChild(option);
    });
  }

  function getPrefetchedAudioUrl(item) {
    if (!item || item._index === undefined || item._mode === undefined) {
      return null;
    }

    const mode = item._mode === "words" ? "words" : "sentences";
    return `${PREFETCHED_AUDIO_BASE}/${mode}/${item._index}.mp3`;
  }

  async function playPreRenderedAudio(item) {
    const url = getPrefetchedAudioUrl(item);
    if (!url) {
      return false;
    }

    try {
      const audio = new Audio(url);
      audio.playbackRate = Number(rateRange.value || 0.95);
      activeAudio = audio;

      audio.onended = () => {
        if (activeAudio === audio) {
          activeAudio = null;
        }
        setStatus("");
      };

      audio.onerror = () => {
        if (activeAudio === audio) {
          activeAudio = null;
        }
      };

      setStatus("Playing SunHi neural audio...");
      await audio.play();
      return true;
    } catch {
      if (activeAudio) {
        activeAudio = null;
      }
      return false;
    }
  }

  function speakBrowserVoice(text) {
    if (!("speechSynthesis" in window)) {
      setStatus("Speech synthesis is not supported in this browser.");
      return;
    }

    if (!text) {
      return;
    }

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "ko-KR";
    utterance.rate = Number(rateRange.value || 0.95);

    const voices = getKoreanVoices();
    const selected = voices.find((voice) => voice.voiceURI === voiceSelect.value);
    if (selected) {
      utterance.voice = selected;
    }

    utterance.onstart = () => setStatus("Using fallback browser voice...");
    utterance.onend = () => setStatus("");
    utterance.onerror = () => setStatus("Could not play audio.");

    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
  }

  async function speakKorean(item) {
    if (!item || !item.korean) {
      return;
    }

    stopPlayback();

    const playedPreRendered = await playPreRenderedAudio(item);
    if (playedPreRendered) {
      return;
    }

    speakBrowserVoice(item.korean);
  }

  newBtn.addEventListener("click", loadNewItem);
  modeSelect.addEventListener("change", loadNewItem);

  revealPlayBtn.addEventListener("click", async () => {
    revealTranslation();
    await speakKorean(current);
  });

  playBtn.addEventListener("click", async () => {
    await speakKorean(current);
  });

  if ("speechSynthesis" in window) {
    populateVoiceSelect();
    window.speechSynthesis.onvoiceschanged = populateVoiceSelect;
  } else {
    populateVoiceSelect();
  }

  loadNewItem();
</script>

<style>
  .practice-shell {
    display: grid;
    gap: 0.9rem;
  }

  .control-row {
    display: grid;
    grid-template-columns: auto minmax(180px, 1fr) auto minmax(180px, 1fr) auto 140px;
    gap: 0.55rem;
    align-items: center;
  }

  .control-row label {
    color: var(--muted);
    font-size: 0.84rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .control-row select,
  .control-row input[type="range"] {
    width: 100%;
    border: 1px solid color-mix(in srgb, var(--muted), transparent 55%);
    background: color-mix(in srgb, var(--bg-soft), transparent 10%);
    color: var(--text);
    border-radius: 10px;
    padding: 0.48rem 0.58rem;
  }

  .sentence {
    min-height: 105px;
    background: color-mix(in srgb, var(--bg-soft), transparent 10%);
    border: 1px solid color-mix(in srgb, var(--muted), transparent 65%);
    border-radius: 14px;
    padding: 0.95rem;
    font-size: clamp(1.25rem, 1.8vw + 0.65rem, 1.95rem);
    line-height: 1.45;
    display: flex;
    align-items: center;
  }

  .translation {
    padding: 0.8rem 0.95rem;
    border-radius: 12px;
    background: color-mix(in srgb, var(--accent), transparent 88%);
    border: 1px solid color-mix(in srgb, var(--accent), transparent 72%);
    min-height: 44px;
  }

  .translation.hidden {
    visibility: hidden;
  }

  .status {
    color: var(--muted);
    min-height: 22px;
  }

  .hint {
    margin: 0;
    color: var(--muted);
    font-size: 0.86rem;
  }

  @media (max-width: 960px) {
    .control-row {
      grid-template-columns: 1fr;
    }

    .control-row label {
      margin-top: 0.2rem;
    }
  }
</style>
