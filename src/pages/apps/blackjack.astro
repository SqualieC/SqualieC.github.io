---
import Layout from '../../layouts/Layout.astro';
---

<Layout
  title="Blackjack Game | SqualieC"
  description="A polished browser blackjack game with custom card visuals, round flow, and session stats."
>
  <section class="hero hero-surface">
    <p class="eyebrow">Online Game</p>
    <h1>Blackjack</h1>
    <p class="lead">
      Play quick rounds directly in the browser. The game uses a multi-deck shoe, proper ace handling, dealer logic,
      and clean table-style visuals that match the rest of the site.
    </p>
  </section>

  <section class="table-shell card section-title">
    <header class="table-header">
      <div>
        <h2>Table</h2>
        <p id="statusText" class="status">Press Deal to start a round.</p>
      </div>
      <div class="controls">
        <button id="dealBtn" class="btn btn-primary" type="button">Deal</button>
        <button id="hitBtn" class="btn btn-secondary" type="button" disabled>Hit</button>
        <button id="standBtn" class="btn btn-secondary" type="button" disabled>Stand</button>
        <button id="doubleBtn" class="btn btn-secondary" type="button" disabled>Double</button>
        <button id="splitBtn" class="btn btn-secondary" type="button" disabled>Split</button>
        <button id="resetBtn" class="btn btn-secondary" type="button">Reset Stats</button>
      </div>
    </header>

    <section class="lane">
      <div class="lane-top">
        <h3>Dealer</h3>
        <span id="dealerScore" class="score-pill">Score: -</span>
      </div>
      <div id="dealerHand" class="hand" aria-live="polite"></div>
    </section>

    <section id="playerLane1" class="lane">
      <div class="lane-top">
        <h3 id="playerLabel1">Player</h3>
        <span id="playerScore" class="score-pill">Score: -</span>
      </div>
      <div id="playerHand" class="hand" aria-live="polite"></div>
    </section>

    <section id="playerLane2" class="lane" style="display:none">
      <div class="lane-top">
        <h3>Hand 2</h3>
        <span id="playerScore2" class="score-pill">Score: -</span>
      </div>
      <div id="playerHand2" class="hand" aria-live="polite"></div>
    </section>

    <section class="stats-grid" aria-label="Session stats">
      <article class="stat">
        <span class="stat-label">Rounds</span>
        <strong id="statRounds">0</strong>
      </article>
      <article class="stat">
        <span class="stat-label">Wins</span>
        <strong id="statWins">0</strong>
      </article>
      <article class="stat">
        <span class="stat-label">Losses</span>
        <strong id="statLosses">0</strong>
      </article>
      <article class="stat">
        <span class="stat-label">Pushes</span>
        <strong id="statPushes">0</strong>
      </article>
      <article class="stat">
        <span class="stat-label">Blackjacks</span>
        <strong id="statBlackjacks">0</strong>
      </article>
    </section>
  </section>
</Layout>

<script>
  const SUITS = ["spades", "hearts", "diamonds", "clubs"];
  const RANKS = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
  const SUIT_SYMBOL = {
    spades: "&spades;",
    hearts: "&hearts;",
    diamonds: "&diams;",
    clubs: "&clubs;"
  };

  const statusText = document.getElementById("statusText");
  const dealerScore = document.getElementById("dealerScore");
  const playerScore = document.getElementById("playerScore");
  const playerScore2 = document.getElementById("playerScore2");
  const dealerHandEl = document.getElementById("dealerHand");
  const playerHandEl = document.getElementById("playerHand");
  const playerHand2El = document.getElementById("playerHand2");
  const playerLane1 = document.getElementById("playerLane1");
  const playerLane2 = document.getElementById("playerLane2");
  const playerLabel1 = document.getElementById("playerLabel1");

  const dealBtn = document.getElementById("dealBtn");
  const hitBtn = document.getElementById("hitBtn");
  const standBtn = document.getElementById("standBtn");
  const doubleBtn = document.getElementById("doubleBtn");
  const splitBtn = document.getElementById("splitBtn");
  const resetBtn = document.getElementById("resetBtn");

  const statRounds = document.getElementById("statRounds");
  const statWins = document.getElementById("statWins");
  const statLosses = document.getElementById("statLosses");
  const statPushes = document.getElementById("statPushes");
  const statBlackjacks = document.getElementById("statBlackjacks");

  const stats = { rounds: 0, wins: 0, losses: 0, pushes: 0, blackjacks: 0 };

  let shoe = [];
  let playerHand = [];
  let dealerHand = [];
  let roundActive = false;
  let hideDealerHole = true;

  // Split state
  let isSplit = false;
  let splitHand2 = [];
  let activeHandIndex = 0; // 0 = playerHand, 1 = splitHand2

  function createShoe(deckCount = 6) {
    const cards = [];
    for (let deck = 0; deck < deckCount; deck += 1) {
      for (const suit of SUITS) {
        for (const rank of RANKS) {
          cards.push({ suit, rank });
        }
      }
    }
    for (let i = cards.length - 1; i > 0; i -= 1) {
      const j = Math.floor(Math.random() * (i + 1));
      [cards[i], cards[j]] = [cards[j], cards[i]];
    }
    return cards;
  }

  function drawCard() {
    if (shoe.length < 30) {
      shoe = createShoe(6);
      setStatus("Shoe reshuffled.");
    }
    return shoe.pop();
  }

  function cardValue(rank) {
    if (rank === "A") return 11;
    if (["K", "Q", "J"].includes(rank)) return 10;
    return Number(rank);
  }

  function scoreHand(hand) {
    let total = 0;
    let aces = 0;
    for (const card of hand) {
      total += cardValue(card.rank);
      if (card.rank === "A") aces += 1;
    }
    while (total > 21 && aces > 0) {
      total -= 10;
      aces -= 1;
    }
    return total;
  }

  function isBlackjack(hand) {
    return hand.length === 2 && scoreHand(hand) === 21;
  }

  function cardMarkup(card, hidden = false) {
    if (hidden) {
      return '<article class="card-face hidden-card" aria-label="Face-down card"></article>';
    }
    const suit = SUIT_SYMBOL[card.suit];
    const isRed = card.suit === "hearts" || card.suit === "diamonds";
    return `
      <article class="card-face ${isRed ? "red" : "black"}" aria-label="${card.rank}${suit}">
        <span class="corner top">${card.rank}${suit}</span>
        <span class="pip">${suit}</span>
        <span class="corner bottom">${card.rank}${suit}</span>
      </article>
    `;
  }

  function renderHand(el, hand, hideHole) {
    el.innerHTML = hand.map((card, index) => cardMarkup(card, hideHole && index === 1)).join("");
  }

  function setStatus(message, tone = "neutral") {
    statusText.textContent = message;
    statusText.dataset.tone = tone;
  }

  function updateStatsUI() {
    statRounds.textContent = String(stats.rounds);
    statWins.textContent = String(stats.wins);
    statLosses.textContent = String(stats.losses);
    statPushes.textContent = String(stats.pushes);
    statBlackjacks.textContent = String(stats.blackjacks);
  }

  function getActiveHand() {
    return isSplit && activeHandIndex === 1 ? splitHand2 : playerHand;
  }

  function updateButtons() {
    const active = getActiveHand();
    dealBtn.disabled = roundActive;
    hitBtn.disabled = !roundActive;
    standBtn.disabled = !roundActive;
    doubleBtn.disabled = !roundActive || active.length !== 2;
    splitBtn.disabled = !roundActive || isSplit || playerHand.length !== 2 ||
      cardValue(playerHand[0].rank) !== cardValue(playerHand[1].rank);
  }

  function updateBoard() {
    renderHand(dealerHandEl, dealerHand, hideDealerHole && roundActive);

    if (isSplit) {
      playerLabel1.textContent = "Hand 1";
      playerLane2.style.display = "";
      renderHand(playerHandEl, playerHand, false);
      renderHand(playerHand2El, splitHand2, false);
      playerScore.textContent = `Score: ${scoreHand(playerHand)}`;
      playerScore2.textContent = `Score: ${scoreHand(splitHand2)}`;
      playerLane1.classList.toggle("active-hand", roundActive && activeHandIndex === 0);
      playerLane2.classList.toggle("active-hand", roundActive && activeHandIndex === 1);
    } else {
      playerLabel1.textContent = "Player";
      playerLane2.style.display = "none";
      playerLane1.classList.remove("active-hand");
      renderHand(playerHandEl, playerHand, false);
      playerScore.textContent = `Score: ${scoreHand(playerHand)}`;
    }

    if (roundActive && hideDealerHole) {
      const visibleDealer = dealerHand[0] ? scoreHand([dealerHand[0]]) : 0;
      dealerScore.textContent = `Score: ${visibleDealer} + ?`;
    } else {
      dealerScore.textContent = `Score: ${scoreHand(dealerHand)}`;
    }

    updateButtons();
    updateStatsUI();
  }

  function finishRound(result, message) {
    roundActive = false;
    hideDealerHole = false;
    stats.rounds += 1;
    if (result === "win") stats.wins += 1;
    if (result === "loss") stats.losses += 1;
    if (result === "push") stats.pushes += 1;
    setStatus(message, result === "win" ? "good" : result === "loss" ? "bad" : "neutral");
    updateBoard();
  }

  function compareHand(handTotal, dealerTotal) {
    if (handTotal > 21) return "loss";
    if (dealerTotal > 21) return "win";
    if (handTotal > dealerTotal) return "win";
    if (handTotal < dealerTotal) return "loss";
    return "push";
  }

  function runDealerAndFinish(hand1, hand2 = null) {
    hideDealerHole = false;
    while (scoreHand(dealerHand) < 17) {
      dealerHand.push(drawCard());
    }
    const dealerTotal = scoreHand(dealerHand);

    if (!hand2) {
      // Single hand
      const playerTotal = scoreHand(hand1);
      if (dealerTotal > 21) { finishRound("win", "Dealer busts. You win."); return; }
      if (dealerTotal > playerTotal) { finishRound("loss", "Dealer wins this round."); return; }
      if (dealerTotal < playerTotal) { finishRound("win", "You win this round."); return; }
      finishRound("push", "Push. It is a tie.");
      return;
    }

    // Split: evaluate both hands
    const r1 = compareHand(scoreHand(hand1), dealerTotal);
    const r2 = compareHand(scoreHand(hand2), dealerTotal);
    const label = (r) => r === "win" ? "Win" : r === "loss" ? "Loss" : "Push";

    roundActive = false;
    stats.rounds += 1;
    if (r1 === "win") stats.wins += 1; else if (r1 === "loss") stats.losses += 1; else stats.pushes += 1;
    if (r2 === "win") stats.wins += 1; else if (r2 === "loss") stats.losses += 1; else stats.pushes += 1;

    const overallTone = (r1 === "win" || r2 === "win") ? "good"
      : (r1 === "loss" && r2 === "loss") ? "bad" : "neutral";
    setStatus(`Hand 1: ${label(r1)} Â· Hand 2: ${label(r2)}`, overallTone);
    updateBoard();
  }

  function handleSplitHandEnd() {
    if (activeHandIndex === 0) {
      activeHandIndex = 1;
      setStatus("Playing Hand 2. Hit, stand, or double.", "neutral");
      updateBoard();
    } else {
      runDealerAndFinish(playerHand, splitHand2);
    }
  }

  function dealRound() {
    playerHand = [drawCard(), drawCard()];
    dealerHand = [drawCard(), drawCard()];
    roundActive = true;
    hideDealerHole = true;
    isSplit = false;
    splitHand2 = [];
    activeHandIndex = 0;

    const playerBj = isBlackjack(playerHand);
    const dealerBj = isBlackjack(dealerHand);

    if (playerBj || dealerBj) {
      if (playerBj && dealerBj) {
        finishRound("push", "Both have blackjack. Push.");
      } else if (playerBj) {
        stats.blackjacks += 1;
        finishRound("win", "Blackjack. You win.");
      } else {
        finishRound("loss", "Dealer blackjack.");
      }
      return;
    }

    setStatus("Your move: hit, stand, double, or split.", "neutral");
    updateBoard();
  }

  function playerHit() {
    if (!roundActive) return;
    const active = getActiveHand();
    active.push(drawCard());
    const total = scoreHand(active);

    if (total > 21) {
      if (isSplit) {
        updateBoard();
        setStatus(`Hand ${activeHandIndex + 1} bust.`, "neutral");
        handleSplitHandEnd();
      } else {
        finishRound("loss", "Bust. Dealer wins.");
      }
      return;
    }

    if (total === 21) {
      if (isSplit) {
        updateBoard();
        handleSplitHandEnd();
      } else {
        setStatus("21 reached. Dealer turn.", "neutral");
        runDealerAndFinish(playerHand);
      }
      return;
    }

    updateBoard();
    setStatus(isSplit ? `Hand ${activeHandIndex + 1}: hit, stand, or double.` : "Choose hit or stand.", "neutral");
  }

  function playerStand() {
    if (!roundActive) return;
    if (isSplit) {
      handleSplitHandEnd();
    } else {
      runDealerAndFinish(playerHand);
    }
  }

  function playerDoubleDown() {
    if (!roundActive) return;
    const active = getActiveHand();
    if (active.length !== 2) return;

    active.push(drawCard());
    const total = scoreHand(active);
    updateBoard();

    if (total > 21) {
      if (isSplit) {
        setStatus(`Hand ${activeHandIndex + 1} bust after double.`, "neutral");
        handleSplitHandEnd();
      } else {
        finishRound("loss", "Bust after doubling. Dealer wins.");
      }
      return;
    }

    // Forced stand after double
    if (isSplit) {
      setStatus(`Hand ${activeHandIndex + 1} doubled to ${total}. Standing.`, "neutral");
      handleSplitHandEnd();
    } else {
      setStatus(`Doubled to ${total}. Dealer turn.`, "neutral");
      runDealerAndFinish(playerHand);
    }
  }

  function playerSplit() {
    if (!roundActive || isSplit || playerHand.length !== 2) return;
    if (cardValue(playerHand[0].rank) !== cardValue(playerHand[1].rank)) return;

    isSplit = true;
    activeHandIndex = 0;
    splitHand2 = [playerHand.pop()];
    playerHand.push(drawCard());
    splitHand2.push(drawCard());

    setStatus("Playing Hand 1. Hit, stand, or double.", "neutral");
    updateBoard();
  }

  function resetStats() {
    stats.rounds = 0;
    stats.wins = 0;
    stats.losses = 0;
    stats.pushes = 0;
    stats.blackjacks = 0;
    updateStatsUI();
    setStatus("Stats reset. Press Deal to start.", "neutral");
  }

  dealBtn.addEventListener("click", dealRound);
  hitBtn.addEventListener("click", playerHit);
  standBtn.addEventListener("click", playerStand);
  doubleBtn.addEventListener("click", playerDoubleDown);
  splitBtn.addEventListener("click", playerSplit);
  resetBtn.addEventListener("click", resetStats);

  shoe = createShoe(6);
  updateBoard();
</script>

<style is:global>
  .table-shell {
    display: grid;
    gap: 1rem;
    background:
      radial-gradient(circle at 20% -40%, color-mix(in srgb, var(--accent), transparent 78%), transparent 52%),
      radial-gradient(circle at 90% -30%, color-mix(in srgb, var(--accent-2), transparent 82%), transparent 48%),
      linear-gradient(165deg, color-mix(in srgb, var(--card), transparent 8%), var(--bg-soft));
  }

  .table-header {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    align-items: flex-start;
    flex-wrap: wrap;
  }

  .table-header h2 {
    font-size: 1.45rem;
    margin-bottom: 0.35rem;
  }

  .status {
    margin: 0;
    color: var(--muted);
  }

  .status[data-tone="good"] {
    color: color-mix(in srgb, var(--accent), white 10%);
  }

  .status[data-tone="bad"] {
    color: color-mix(in srgb, var(--accent-2), white 8%);
  }

  .controls {
    display: flex;
    gap: 0.55rem;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .controls .btn:disabled {
    opacity: 0.45;
    cursor: not-allowed;
  }

  .lane {
    border: 1px solid color-mix(in srgb, var(--muted), transparent 68%);
    border-radius: 16px;
    padding: 0.95rem;
    background: color-mix(in srgb, var(--bg-soft), transparent 12%);
    transition: border-color 140ms ease, box-shadow 140ms ease;
  }

  .lane.active-hand {
    border-color: color-mix(in srgb, var(--accent), transparent 35%);
    box-shadow: 0 0 0 1px color-mix(in srgb, var(--accent), transparent 60%);
  }

  .lane-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.7rem;
  }

  .score-pill {
    border-radius: 999px;
    padding: 0.22rem 0.62rem;
    font-size: 0.8rem;
    color: var(--muted);
    border: 1px solid color-mix(in srgb, var(--muted), transparent 60%);
    background: color-mix(in srgb, var(--bg), transparent 25%);
  }

  .hand {
    min-height: 146px;
    display: flex;
    flex-wrap: wrap;
    gap: 0.72rem;
    align-items: center;
  }

  .card-face {
    width: 92px;
    height: 132px;
    border-radius: 13px;
    border: 1px solid color-mix(in srgb, #0f1727, transparent 35%);
    background: linear-gradient(160deg, #fefefe 0%, #f2f5ff 100%);
    box-shadow:
      0 8px 20px color-mix(in srgb, #000, transparent 76%),
      inset 0 0 0 1px color-mix(in srgb, #fff, transparent 45%);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    overflow: hidden;
  }

  .card-face.red { color: #d1264f; }
  .card-face.black { color: #1a2a4d; }

  .card-face .pip {
    font-size: 2.05rem;
    line-height: 1;
    transform: translateY(-2px);
  }

  .card-face .corner {
    position: absolute;
    font-size: 0.95rem;
    line-height: 1;
    letter-spacing: 0.01em;
  }

  .card-face .corner.top { top: 8px; left: 9px; }
  .card-face .corner.bottom { right: 9px; bottom: 8px; transform: rotate(180deg); }

  .hidden-card {
    border: 1px solid color-mix(in srgb, var(--ring), transparent 60%);
    background:
      repeating-linear-gradient(
        45deg,
        color-mix(in srgb, var(--accent), transparent 28%) 0 9px,
        color-mix(in srgb, var(--accent-2), transparent 30%) 9px 18px
      );
  }

  .hidden-card::after {
    content: "";
    position: absolute;
    inset: 10px;
    border-radius: 8px;
    border: 1px solid color-mix(in srgb, #fff, transparent 45%);
    background: color-mix(in srgb, var(--bg-soft), transparent 55%);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(5, minmax(88px, 1fr));
    gap: 0.55rem;
  }

  .stat {
    border-radius: 12px;
    border: 1px solid color-mix(in srgb, var(--muted), transparent 70%);
    padding: 0.62rem;
    display: grid;
    gap: 0.2rem;
    background: color-mix(in srgb, var(--bg-soft), transparent 12%);
  }

  .stat-label {
    color: var(--muted);
    font-size: 0.76rem;
    text-transform: uppercase;
    letter-spacing: 0.07em;
  }

  .stat strong { font-size: 1.12rem; }

  @media (max-width: 920px) {
    .stats-grid { grid-template-columns: repeat(2, minmax(130px, 1fr)); }
  }

  @media (max-width: 680px) {
    .hand { min-height: 122px; gap: 0.52rem; }
    .card-face { width: 78px; height: 113px; }
    .card-face .pip { font-size: 1.68rem; }
    .controls { width: 100%; }
    .controls .btn { flex: 1 1 calc(50% - 0.4rem); }
  }
</style>
